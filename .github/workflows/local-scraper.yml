name: Local Scraper (GitHub-hosted)

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:  # Manual trigger

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run local scraper (Puppeteer on GitHub)
        run: node local-scraper.js
        
      - name: Upload to Azure Blob Storage
        if: success()
        run: |
          npm install @azure/storage-blob --save
          node << 'EOF'
          const fs = require('fs');
          const { BlobServiceClient } = require('@azure/storage-blob');
          
          const connStr = process.env.AZURE_STORAGE_CONNECTION;
          if (!connStr) {
            console.error('❌ Error: AZURE_STORAGE_CONNECTION secret not set!');
            console.error('Please add the secret to GitHub repository settings');
            console.error('Go to: https://github.com/balrng/kogb/settings/secrets/actions');
            process.exit(1);
          }
          
          try {
            const data = fs.readFileSync('local-scrape.json', 'utf-8');
            const client = BlobServiceClient.fromConnectionString(connStr);
            const container = client.getContainerClient('cache');
            const blob = container.getBlobClient('latest_with_trend.json');
            
            blob.upload(data, Buffer.byteLength(data)).then(() => {
              const parsed = JSON.parse(data);
              console.log('✓ Uploaded to Azure Blob Storage');
              console.log(`  Vendors: ${parsed.vendors.length}`);
              console.log(`  Timestamp: ${parsed.scrapedAt}`);
            }).catch(err => {
              console.error('✗ Upload failed:', err.message);
              process.exit(1);
            });
          } catch (error) {
            console.error('✗ Error:', error.message);
            process.exit(1);
          }
          EOF
        env:
          AZURE_STORAGE_CONNECTION: ${{ secrets.AZURE_STORAGE_CONNECTION }}
        
      - name: Workflow Status
        if: success()
        run: echo "✓ Scraper ran successfully and updated Azure Blob Storage"
